<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡∏ô‡∏®‡∏¥‡∏•‡∏≤‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</title>

<!-- Thai Prompt font -->
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

<style>
  :root{
    --grad-start:#93c5fd; /* sky-300 */
    --grad-end:#e0e7ff;   /* indigo-100 */
  }
  html,body{height:100%;}
  body{font-family:'Prompt',sans-serif;background:linear-gradient(135deg,var(--grad-start),var(--grad-end));}
  .soft-card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(31,41,55,.08),0 2px 8px rgba(31,41,55,.06);}
  .btn{background:#fff;border:1px solid rgba(148,163,184,.5);border-radius:12px;padding:.5rem .9rem;font-weight:600}
  .btn:hover{background:#f8fafc}
  .btn-primary{background:linear-gradient(135deg,#60a5fa,#6366f1);color:#fff;border:none}
  .btn-primary:hover{filter:brightness(.98)}
  .header-logo{width:56px;height:56px;border-radius:50%;object-fit:cover;border:4px solid #fff;box-shadow:0 4px 14px rgba(2,132,199,.25)}
  /* Month grid */
  .cal-grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:.75rem}
  .day{min-height:120px;background:#fff;border-radius:14px;position:relative;padding:10px 10px 8px 10px;box-shadow:inset 0 0 0 1px rgba(15,23,42,.04)}
  .day .num{position:absolute;top:10px;left:12px;font-weight:700;color:#334155}
  .day.muted{background:transparent;box-shadow:none}
  .day.sun{background:rgba(239,68,68,.06)}
  .day.sat{background:rgba(99,102,241,.06)}
  .today-badge{position:absolute;top:10px;right:10px;background:#0ea5e9;color:#fff;font-size:.7rem;border-radius:999px;padding:2px 8px}
  .chip{display:flex;gap:.4rem;align-items:center;font-size:.78rem;margin:.35rem 0 0;padding:.35rem .55rem;border-radius:10px;background:#f1f5f9;color:#0f172a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .chip.range{background:#ecfeff}
  .chip.allDay{background:#eef2ff}
  .chip:hover{box-shadow:0 4px 10px rgba(2,132,199,.12)}
  .top-stat .label{color:#64748b;font-size:.85rem}
  .top-stat .num{font-weight:800;color:#0f172a}
  /* list cards */
  .card{background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(2,6,23,.06),0 1px 6px rgba(2,6,23,.06)}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal.show{display:flex}
  .modal .panel{background:#fff;border-radius:20px;box-shadow:0 25px 60px rgba(2,6,23,.25);max-width:760px;width:92%;padding:18px}
  .year-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media(min-width:1024px){.year-grid{grid-template-columns:repeat(4,1fr)}}
</style>
</head>
<body class="pb-16">

<!-- HEADER -->
<header class="soft-card max-w-6xl mx-auto mt-6 p-4 sm:p-6">
  <div class="flex items-center gap-3">
    <!-- ‡πÇ‡∏•‡πÇ‡∏Å‡πâ: ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà src -->
    <img class="header-logo" src="https://raw.githubusercontent.com/nskvichakarn/nskvichakarn.github.io/main/logo-nsph.png" onerror="this.src='https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f3eb.svg'">
    <div>
      <h1 class="text-xl sm:text-2xl font-extrabold text-slate-800">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡∏ô‡∏®‡∏¥‡∏•‡∏≤‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°
      </h1>
      <div class="text-slate-500 text-sm">
        ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheets ¬∑ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏ó‡∏¢ (‡∏û.‡∏®.)
      </div>
    </div>
    <div class="ml-auto flex items-center gap-2">
      <span class="rounded-full bg-white/70 px-3 py-1 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: <b id="connStatus">‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</b></span>
      <span class="rounded-full bg-white/70 px-3 py-1 text-sm">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="countAll">0</b></span>
      <span class="rounded-full bg-white/70 px-3 py-1 text-sm">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <b id="countMonth">0</b></span>
      <span class="rounded-full bg-white/70 px-3 py-1 text-sm">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <b id="countToday">0</b></span>
    </div>
  </div>
</header>

<!-- CONTROL BAR -->
<section class="soft-card max-w-6xl mx-auto mt-4 p-4 sm:p-5">
  <div class="flex flex-wrap items-center gap-3">
    <div class="flex gap-2">
      <button id="btnViewMonth" class="btn">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
      <button id="btnViewList"  class="btn">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      <button id="btnViewYear"  class="btn">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
    </div>

    <div class="flex items-center gap-2 mx-auto">
      <button id="btnPrev" class="btn">‚Äπ</button>
      <div class="rounded-full bg-gradient-to-tr from-sky-400 to-blue-500 text-white px-4 py-1 text-sm font-semibold">
        <span id="currentMonthLabel">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏õ‡∏µ</span>
      </div>
      <button id="btnNext" class="btn">‚Ä∫</button>
      <button id="btnToday" class="btn">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>

    <div class="flex gap-2 ml-auto">
      <button id="btnSync" class="btn">‡∏ã‡∏¥‡∏á‡∏Å‡πå Google Sheets</button>
      <button id="btnAdmin" class="btn btn-primary">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
    </div>
  </div>

  <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏¢‡πà‡∏≠‡∏¢ -->
  <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 mt-4">
    <div class="soft-card top-stat p-3"><div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="num" id="statAll">0</div></div>
    <div class="soft-card top-stat p-3"><div class="label">‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div><div class="num" id="statMonth">0</div></div>
    <div class="soft-card top-stat p-3"><div class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div><div class="num" id="statConn">‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</div></div>
    <div class="soft-card top-stat p-3"><div class="label">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô</div>
      <div class="flex gap-2 mt-2 text-sm">
        <select id="quickOwner" class="border rounded-md px-2 py-1">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option>
        </select>
        <select id="quickLocation" class="border rounded-md px-2 py-1">
          <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>
        </select>
      </div>
    </div>
  </div>
</section>

<!-- CALENDAR VIEWS -->
<section class="max-w-6xl mx-auto mt-4 mb-24">

  <!-- Month View -->
  <div id="viewMonth" class="soft-card p-4 sm:p-6">
    <div class="grid grid-cols-7 gap-3 text-center text-slate-600 font-semibold mb-2">
      <div>‡∏≠‡∏≤</div><div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div>‡∏™</div>
    </div>
    <div class="cal-grid" id="monthGrid"></div>
    <div class="mt-6">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-bold text-slate-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
        <button id="btnToggleAll" class="btn text-sm">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á</button>
      </div>
      <div id="monthList" class="space-y-3"></div>
    </div>
  </div>

  <!-- List View -->
  <div id="viewList" class="soft-card p-4 sm:p-6 hidden">
    <div class="flex flex-wrap items-center gap-2 mb-3">
      <input id="searchBox" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö)" class="border rounded-lg px-3 py-2 w-full sm:w-96">
      <select id="listMonth" class="border rounded-lg px-3 py-2">
      </select>
    </div>
    <div id="listContainer" class="space-y-3"></div>
  </div>

  <!-- Year View -->
  <div id="viewYear" class="soft-card p-4 sm:p-6 hidden">
    <div class="year-grid" id="yearContainer"></div>
  </div>
</section>

<!-- Modal: ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô -->
<div id="modal-day" class="modal">
  <div class="panel">
    <div class="flex items-center justify-between mb-2">
      <div class="text-lg font-bold" id="modalDayTitle">‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ...</div>
      <button class="btn" onclick="$('#modal-day').removeClass('show')">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div id="modalDayList" class="space-y-2"></div>
  </div>
</div>

<!-- Modal: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) -->
<div id="modal-detail" class="modal">
  <div class="panel">
    <div class="flex items-center justify-between mb-2">
      <div class="text-lg font-bold" id="detailTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</div>
      <button class="btn" onclick="$('#modal-detail').removeClass('show')">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div id="detailBody" class="text-slate-700 text-sm"></div>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwSkvApjUvQAxn0LijGSEA7GVuPO_LeQGErgmOlugu4_MCrcH2w_k6V2efz7DFxNCf8/exec';
const ADMIN_PASSWORD = 'adminvichakarn';
const CACHE_KEY = 'nsph_events_cache_v2';

/* ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ/‡∏ä‡∏¥‡∏û/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• dropdown */
const EMOJI_CHOICES = ["üè´","üìö","üìù","üì¢","üìä","üß™","üß¨","üß†","üí°","üéì","üìÖ","‚è∞","üìç","üßëüèª‚Äçüè´","üßëüèª‚Äçüéì","üõ†Ô∏è"];
const LOCATIONS = [
 "‡∏´‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏®‡∏¥‡∏•‡∏≤‡∏ô‡∏∏‡∏™‡∏£‡∏ì‡πå","‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏õ‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï‡∏¥","‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ü‡πâ‡∏≤","‡πÇ‡∏£‡∏á‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô","‡∏™‡∏ô‡∏≤‡∏°‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•","‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå‡∏ö‡∏≠‡∏•","‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á",
 "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏°‡∏µ","‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤","‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°","‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏†‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏´‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£","‡∏´‡πâ‡∏≠‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì","‡∏´‡πâ‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
 "‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô","‡∏´‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û","‡∏´‡πâ‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢","‡∏´‡πâ‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©","‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•","‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå","‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå","‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î"
];
const OWNERS = [
 "‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£","‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì","‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ","‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•","‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"
];

/* =========================
   STATE
========================= */
const STATE = {
  events: [],
  cursor: new Date(),
  today: new Date(),
  view: 'month', // month | list | year
  filterOwner: '',
  filterLocation: ''
};

/* =========================
   HELPERS
========================= */
function buddhistLabel(d){
  const thMonths=["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
  return ${thMonths[d.getMonth()]} ${d.getFullYear()+543};
}
function sameDate(a,b){ return a.getFullYear()==b.getFullYear() && a.getMonth()==b.getMonth() && a.getDate()==b.getDate(); }
function parseAny(v){
  if(!v) return null;
  if(v instanceof Date) return v;
  if(typeof v==='number'){ const base=new Date(Date.UTC(1899,11,30)); return new Date(base.getTime()+v*86400000); }
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)){ const [Y,M,D]=v.split('-').map(Number); return new Date(Y,M-1,D); }
  const d=new Date(v); return isNaN(d)?null:d;
}
function eventDays(ev){
  const d=parseAny(ev.date), s=parseAny(ev.startDate), e=parseAny(ev.endDate);
  if(d) return [d];
  if(s&&e){ const arr=[]; let c=new Date(s); while(c<=e){ arr.push(new Date(c)); c.setDate(c.getDate()+1); } return arr; }
  if(s) return [s];
  return [];
}
function timeLabel(ev){
  if(ev.startTime && ev.endTime) return ${ev.startTime}-${ev.endTime};
  if(ev.startTime) return ev.startTime;
  return '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô';
}
function escapeHtml(t){ return (t??'').toString().replace(/[&<>"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }

/* =========================
   STORAGE
========================= */
function saveCache(d){ localStorage.setItem(CACHE_KEY, JSON.stringify(d)); }
function loadCache(){ try{ return JSON.parse(localStorage.getItem(CACHE_KEY)||'[]'); }catch{ return []; } }

/* =========================
   RENDER
========================= */
function refreshHeader(){
  $('#currentMonthLabel').text(buddhistLabel(STATE.cursor));
  $('#connStatus').text($('#statConn').text());
}
function countStats(){
  const y=STATE.cursor.getFullYear(), m=STATE.cursor.getMonth();
  const monthEvents = STATE.events.filter(ev=>{
    const d=parseAny(ev.date), s=parseAny(ev.startDate), e=parseAny(ev.endDate);
    if(d) return d.getFullYear()==y && d.getMonth()==m;
    if(s&&e){ const ms=new Date(y,m,1), me=new Date(y,m+1,0); return e>=ms && s<=me; }
    if(s) return s.getFullYear()==y && s.getMonth()==m;
    return false;
  });
  const todayCount = STATE.events.filter(ev => eventDays(ev).some(x=>sameDate(x,STATE.today))).length;

  $('#countAll,#statAll').text(STATE.events.length);
  $('#countMonth,#statMonth').text(monthEvents.length);
  $('#countToday').text(todayCount);
}
function chipHtml(ev){
  const title = (ev.title && ev.title.toString().trim()) ? ev.title : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
  const kind = ev.date ? 'allDay' : (ev.startDate && ev.endDate ? 'range' : 'allDay');
  const time = timeLabel(ev);
  return `
    <div class="chip ${kind}" onclick="openDetail('${ev.id}')">
      <span>${ev.emoji || 'üìå'} ${escapeHtml(title)}</span>
      <span class="opacity-70">‚Ä¢ ${escapeHtml(time)}</span>
    </div>
  `;
}
function openDetail(id){
  const e = STATE.events.find(x=>x.id==id);
  if(!e) return;
  $('#detailTitle').text${e.emoji||'üìå'} ${e.title||'‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô'}`);
  const range = (()=>{ 
    const d=parseAny(e.date), s=parseAny(e.startDate), ed=parseAny(e.endDate);
    const thM=["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
    const f=d=>`${d.getDate()} ${thM[d.getMonth()]} ${d.getFullYear()+543}`;
    if(d) return f(d);
    if(s&&ed) return ${f(s)} ‚Äì ${f(ed)};
    if(s) return f(s);
    return '';
  })();

  $('#detailBody').html(`
    <div class="space-y-1">
      <div><b>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤:</b> ${range} ‚Ä¢ ${timeLabel(e)}</div>
      ${e.location?`<div><b>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</b> ${escapeHtml(e.location)}</div>`:''}
      ${e.owner?`<div><b>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</b> ${escapeHtml(e.owner)}</div>`:''}
      ${e.details?`<div class="mt-2 whitespace-pre-wrap"><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b><br>${escapeHtml(e.details)}</div>`:''}
      <div class="text-xs text-slate-400">ID: ${e.id||'-'}</div>
    </div>
  `);
  $('#modal-detail').addClass('show');
}
function openDayModal(iso){
  const d=new Date(iso);
  const thMonths=["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
  $('#modalDayTitle').text(‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${d.getDate()} ${thMonths[d.getMonth()]} ${d.getFullYear()+543});
  const evs = STATE.events.filter(ev=>eventDays(ev).some(x=>sameDate(x,d)));
  $('#modalDayList').html( evs.map(e=>`
    <div class="card p-3 flex items-start justify-between gap-2">
      <div>
        <div class="flex items-center gap-2 text-sky-700">
          <span class="text-xl">${e.emoji||'üìå'}</span>
          <b>${escapeHtml(e.title||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°')}</b>
        </div>
        <div class="text-xs text-slate-600 mt-1">‡πÄ‡∏ß‡∏•‡∏≤: ${escapeHtml(timeLabel(e))} ${e.location?`‚Ä¢ ${escapeHtml(e.location)}`:''}</div>
      </div>
      <button class="btn" onclick="openDetail('${e.id}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
    </div>
  ).join('') || `<div class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>);
  $('#modal-day').addClass('show');
}
function renderMonthGrid(){
  const y=STATE.cursor.getFullYear(), m=STATE.cursor.getMonth();
  $('#currentMonthLabel').text(buddhistLabel(STATE.cursor));
  const first=new Date(y,m,1), start=first.getDay(), last=new Date(y,m+1,0).getDate();
  const frag=[];
  for(let i=0;i<start;i++) frag.push(<div class="day muted"></div>);
  for(let d=1; d<=last; d++){
    const dt = new Date(y,m,d);
    const evs = STATE.events
      .filter(ev=>{
        if(STATE.filterOwner && ev.owner!==STATE.filterOwner) return false;
        if(STATE.filterLocation && ev.location!==STATE.filterLocation) return false;
        return eventDays(ev).some(x=>sameDate(x,dt));
      });
    const chips = evs.map(chipHtml).join('');
    const badge = sameDate(dt, STATE.today) ? <span class="today-badge">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span> : '';
    const wk = dt.getDay()==0?'sun': (dt.getDay()==6?'sat':'');
    frag.push(`
      <div class="day ${wk}" onclick="openDayModal('${dt.toISOString()}')">
        ${badge}
        <div class="num">${d}</div>
        <div class="mt-6">${ chips || <div class="text-xs text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div> }</div>
      </div>
    `);
  }
  while(frag.length%7!==0) frag.push(<div class="day muted"></div>);
  $('#monthGrid').html(frag.join(''));

  // ‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
  const monthData = STATE.events.filter(ev=>{
    const d=parseAny(ev.date), s=parseAny(ev.startDate), e=parseAny(ev.endDate);
    if(d) return d.getFullYear()==y && d.getMonth()==m;
    if(s&&e){ const ms=new Date(y,m,1), me=new Date(y,m+1,0); return e>=ms && s<=me; }
    if(s) return s.getFullYear()==y && s.getMonth()==m;
    return false;
  }).sort((a,b)=> (parseAny(a.date)||parseAny(a.startDate)) - (parseAny(b.date)||parseAny(b.startDate)));
  const thMShort=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
  $('#monthList').html(monthData.map(ev=>{
    const start = parseAny(ev.date)||parseAny(ev.startDate)||new Date();
    const d = ('0'+start.getDate()).slice(-2);
    const mmm = thMShort[start.getMonth()];
    const yy = start.getFullYear()+543;
    return `
      <div class="card p-3 grid grid-cols-8 sm:grid-cols-12 gap-3 items-center">
        <div class="col-span-2 sm:col-span-1 text-center">
          <div class="text-lg font-extrabold">${d}</div>
          <div class="text-xs text-slate-500">${mmm} ${yy}</div>
        </div>
        <div class="col-span-6 sm:col-span-9">
          <div class="flex items-center gap-2 text-sky-700">
            <span class="text-xl">${ev.emoji||'üìå'}</span>
            <b>${escapeHtml(ev.title||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°')}</b>
          </div>
          <div class="text-xs text-slate-600 mt-1">
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${escapeHtml((()=>{const d=parseAny(ev.date),s=parseAny(ev.startDate),e=parseAny(ev.endDate);const f=x=>`${x.getDate()} ${thMShort[x.getMonth()]} ${x.getFullYear()+543}`; if(d) return f(d); if(s&&e) return f(s)+' ‚Äì '+f(e); if(s) return f(s); return ''})())}
            ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: ${escapeHtml(timeLabel(ev))}
            ${ev.location?`‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${escapeHtml(ev.location)}`:''}
            ${ev.owner?`‚Ä¢ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${escapeHtml(ev.owner)}`:''}
          </div>
        </div>
        <div class="col-span-0 sm:col-span-2 justify-self-end">
          <button class="btn" onclick="openDetail('${ev.id}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
        </div>
      </div>
    `;
  }).join('') || <div class="text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>);
}
function renderListView(){
  const q = ($('#searchBox').val()||'').toLowerCase();
  const monthIso = $('#listMonth').val();
  const y = STATE.cursor.getFullYear(), m = STATE.cursor.getMonth();
  const inMonth = (ev)=>{
    const d=parseAny(ev.date), s=parseAny(ev.startDate), e=parseAny(ev.endDate);
    const yy = monthIso ? Number(monthIso.split('-')[0]) : y;
    const mm = monthIso ? Number(monthIso.split('-')[1])-1 : m;
    if(d) return d.getFullYear()==yy && d.getMonth()==mm;
    if(s&&e){ const ms=new Date(yy,mm,1), me=new Date(yy,mm+1,0); return e>=ms && s<=me; }
    if(s) return s.getFullYear()==yy && s.getMonth()==mm;
    return false;
  };
  const list = STATE.events.filter(ev=>{
    if(!inMonth(ev)) return false;
    if(STATE.filterOwner && ev.owner!==STATE.filterOwner) return false;
    if(STATE.filterLocation && ev.location!==STATE.filterLocation) return false;
    const blob = ${ev.title} ${ev.location} ${ev.owner} ${ev.details}.toLowerCase();
    return blob.includes(q);
  }).sort((a,b)=> (parseAny(a.date)||parseAny(a.startDate)) - (parseAny(b.date)||parseAny(b.startDate)));

  const thMShort=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
  $('#listContainer').html(list.map(ev=>{
    const start = parseAny(ev.date)||parseAny(ev.startDate)||new Date();
    const d = ('0'+start.getDate()).slice(-2);
    const mmm = thMShort[start.getMonth()];
    const yy = start.getFullYear()+543;
    return `
      <div class="card p-3 flex items-start justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-12 text-center">
            <div class="text-lg font-extrabold">${d}</div>
            <div class="text-xs text-slate-500">${mmm}<br>${yy}</div>
          </div>
          <div>
            <div class="flex items-center gap-2 text-sky-700">
              <span class="text-xl">${ev.emoji||'üìå'}</span>
              <b>${escapeHtml(ev.title||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°')}</b>
            </div>
            <div class="text-xs text-slate-600 mt-1">
              ‡πÄ‡∏ß‡∏•‡∏≤: ${escapeHtml(timeLabel(ev))}
              ${ev.location?`‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${escapeHtml(ev.location)}`:''}
              ${ev.owner?`‚Ä¢ ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${escapeHtml(ev.owner)}`:''}
            </div>
          </div>
        </div>
        <button class="btn" onclick="openDetail('${ev.id}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
      </div>
    `;
  }).join('') || <div class="text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>);
}
function renderYearView(){
  const y = STATE.cursor.getFullYear();
  const months = Array.from({length:12}, (_,i)=>new Date(y,i,1));
  const thM=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
  const boxes = months.map(d=>{
    const m=d.getMonth();
    const start=d.getDay(), last=new Date(y,m+1,0).getDate();
    let cells='';
    for(let i=0;i<start;i++) cells+=`<div class="text-slate-300">¬∑</div>`;
    for(let day=1; day<=last; day++){
      const has = STATE.events.some(ev=>eventDays(ev).some(x=>x.getFullYear()==y && x.getMonth()==m && x.getDate()==day));
      cells += <div class="${has?'text-sky-600 font-bold':'text-slate-600'}">${day}</div>;
    }
    return `
      <div class="card p-3">
        <div class="font-bold text-slate-700 mb-2">${thM[m]} ${y+543}</div>
        <div class="grid grid-cols-7 gap-1 text-[12px]">${cells}</div>
      </div>
    `;
  }).join('');
  $('#yearContainer').html(boxes);
}

/* =========================
   DATA
========================= */
async function syncFromGAS(){
  $('#connStatus,#statConn').text('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Å‡πå‚Ä¶');
  try{
    const res = await fetch(GAS_ENDPOINT, {cache:'no-store'});
    const json = await res.json();
    if(json.status==='ok' && Array.isArray(json.data)){
      // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° dropdown ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      STATE.events = json.data.map(x=>({
        id: x.id || ('ev_'+Date.now()),
        title: x.title || '',
        date: x.date || '',
        startDate: x.startDate || '',
        endDate: x.endDate || '',
        startTime: x.startTime || '',
        endTime: x.endTime || '',
        location: x.location || '',
        owner: x.owner || '',
        details: x.details || '',
        emoji: x.emoji || ''
      }));
      saveCache(STATE.events);
      $('#connStatus,#statConn').text('‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå');
      confetti({particleCount:120, spread:70, origin:{y:0.2}});
      renderAll();
    }else{
      throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }
  }catch(err){
    $('#connStatus,#statConn').text('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå');
    Swal.fire('‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå','‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß','info');
    STATE.events = loadCache();
    renderAll();
  }
}

/* =========================
   UI actions
========================= */
function renderAll(){
  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
  const owners = [...new Set(STATE.events.map(e=>e.owner).filter(Boolean))];
  const locs   = [...new Set(STATE.events.map(e=>e.location).filter(Boolean))];
  $('#quickOwner').html(<option value="">‡∏ó‡∏∏‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</option> + owners.map(o=>`<option>${escapeHtml(o)}</option>`).join(''));
  $('#quickLocation').html(<option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option> + locs.map(o=>`<option>${escapeHtml(o)}</option>`).join(''));
  // month list dropdown
  const months = Array.from({length:13}, (_,i)=>{const d=new Date(); d.setMonth(d.getMonth()+i-6); return d;});
  $('#listMonth').html(months.map(d=>`<option value="${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}">${buddhistLabel(d)}</option>`).join(''));

  refreshHeader();
  countStats();

  if(STATE.view==='month'){ $('#viewMonth').show(); $('#viewList,#viewYear').hide(); renderMonthGrid(); }
  if(STATE.view==='list'){  $('#viewList').show();  $('#viewMonth,#viewYear').hide(); renderListView(); }
  if(STATE.view==='year'){  $('#viewYear').show();  $('#viewMonth,#viewList').hide(); renderYearView(); }
}

$(function(){
  // ‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á
  $('#btnViewMonth').on('click',()=>{ STATE.view='month'; renderAll(); });
  $('#btnViewList').on('click', ()=>{ STATE.view='list';  renderAll(); });
  $('#btnViewYear').on('click', ()=>{ STATE.view='year';  renderAll(); });

  // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  $('#btnPrev').on('click',()=>{ STATE.cursor.setMonth(STATE.cursor.getMonth()-1); renderAll(); });
  $('#btnNext').on('click',()=>{ STATE.cursor.setMonth(STATE.cursor.getMonth()+1); renderAll(); });
  $('#btnToday').on('click',()=>{ STATE.cursor = new Date(); renderAll(); });

  // ‡∏ã‡∏¥‡∏á‡∏Å‡πå
  $('#btnSync').on('click', async ()=>{ 
  await synchronizeNow(); 
});

// ===============================
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Sync Google Sheets
// ===============================
async function synchronizeNow(){
  try{
    await showLoading(true);
    const onlineData = await fetchFromGAS();   // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Apps Script
    if(onlineData && Array.isArray(onlineData)){
      STATE.events = normalizeIncoming(onlineData); // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      saveToCache(STATE.events);
      confetti({ particleCount: 140, spread: 70 });
      Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÅ‡∏•‡πâ‡∏ß','success');
    }else{
      Swal.fire('‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå','‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß','info');
      STATE.events = loadFromCache();
    }
    renderAll();
    fillSelectsForEditDelete && fillSelectsForEditDelete();
  }catch(e){
    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', String(e.message||e), 'error');
  }finally{
    showLoading(false);
  }
}

  // ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
  $('#quickOwner').on('change', function(){ STATE.filterOwner = this.value; renderAll(); });
  $('#quickLocation').on('change', function(){ STATE.filterLocation = this.value; renderAll(); });
  $('#searchBox').on('input', ()=> renderListView());
  $('#listMonth').on('change', ()=> renderListView());

  // ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏â‡∏¢ ‡πÜ ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)
  $('#btnAdmin').on('click', async ()=>{
    const {value: pw} = await Swal.fire({title:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', input:'password', inputPlaceholder:'‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', confirmButtonText:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', showCancelButton:true});
    if(pw===ADMIN_PASSWORD){
      Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î CRUD ‡πÅ‡∏ï‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß)','success');
    }else if(pw!==undefined){
      Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error');
    }
  });

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ã‡∏¥‡∏á‡∏Å‡πå
  STATE.events = loadCache();
  renderAll();
  syncFromGAS();
});
</script>
</body>
</html>
