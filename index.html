<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: "TH Sarabun New", sans-serif; background:#f3f7ff; margin:0; }
    header { background:#0056d2; color:white; padding:15px; text-align:center; }
    h1 { margin:0; font-size:1.5rem; }
    .container { padding:20px; }
    .filters, .actions { margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap; }
    select, input, button { padding:6px 10px; border-radius:5px; border:1px solid #ccc; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f0f0f0; }
    .tag { padding:2px 6px; border-radius:4px; color:white; font-size:0.9em; }
    .tag.‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ { background:#d9534f; }
    .tag.‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ { background:#0275d8; }
    .tag.‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ { background:#5cb85c; }
    .admin-btns button { margin-right:5px; }
    #eventForm { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
                 background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    #eventForm form { background:white; padding:20px; border-radius:8px; width:350px; }
  </style>
</head>
<body>
  <header>
    <h1>üìÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</h1>
  </header>

  <div class="container">
    <!-- üîé ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á -->
    <div class="filters">
      <select id="filterDept">
        <option value="">‡∏ó‡∏∏‡∏Å‡∏ù‡πà‡∏≤‡∏¢</option>
        <option value="‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£">‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</option>
        <option value="‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£">‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
        <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
      </select>
      <input type="text" id="filterKeyword" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
      <input type="date" id="filterStart">
      <input type="date" id="filterEnd">
      <button onclick="loadEvents()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>

    <!-- ‚öôÔ∏è ‡∏õ‡∏∏‡πà‡∏° -->
    <div class="actions">
      <button onclick="exportCSV()">‚¨áÔ∏è CSV</button>
      <button onclick="window.print()">üñ®Ô∏è PDF</button>
      <button onclick="openForm()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>
    </div>

    <!-- üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
    <table>
      <thead>
        <tr>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="eventTable"></tbody>
    </table>
  </div>

  <!-- üìå Modal Form -->
  <div id="eventForm">
    <form onsubmit="saveEvent(event)">
      <h3 id="formTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</h3>
      <input type="hidden" id="eventId">
      <input type="date" id="date" required><br><br>
      <input type="text" id="title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" required><br><br>
      <input type="time" id="startTime"> ‡∏ñ‡∏∂‡∏á <input type="time" id="endTime"><br><br>
      <input type="text" id="location" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà"><br><br>
      <select id="owner">
        <option value="‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£">‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</option>
        <option value="‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£">‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</option>
        <option value="‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ">‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
      </select><br><br>
      <textarea id="details" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î"></textarea><br><br>
      <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button type="button" onclick="closeForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </form>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwSkvApjUvQAxn0LijGSEA7GVuPO_LeQGErgmOlugu4_MCrcH2w_k6V2efz7DFxNCf8/exec";
    let events = [];

    async function loadEvents(){
      let res = await fetch(API_URL);
      let json = await res.json();
      events = json.data;

      const dept = document.getElementById("filterDept").value;
      const kw = document.getElementById("filterKeyword").value.toLowerCase();
      const fs = document.getElementById("filterStart").value;
      const fe = document.getElementById("filterEnd").value;

      let filtered = events.filter(ev=>{
        if(dept && ev.owner !== dept) return false;
        if(kw && !ev.title.toLowerCase().includes(kw)) return false;
        if(fs && ev.date < fs) return false;
        if(fe && ev.date > fe) return false;
        return true;
      });

      renderTable(filtered);
    }

    function renderTable(list){
      const tbody = document.getElementById("eventTable");
      tbody.innerHTML = "";
      list.forEach(ev=>{
        let tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ev.date}</td>
          <td>${ev.title}</td>
          <td>${ev.startTime||""} - ${ev.endTime||""}</td>
          <td>${ev.location||""}</td>
          <td><span class="tag ${ev.owner}">${ev.owner}</span></td>
          <td>${ev.details||""}</td>
          <td class="admin-btns">
            <button onclick="editEvent('${ev.id}')">‚úèÔ∏è</button>
            <button onclick="deleteEvent('${ev.id}')">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);

        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏á‡∏≤‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        if(ev.startTime){
          scheduleNotification(ev);
        }
      });
    }

    function openForm(ev=null){
      document.getElementById("eventForm").style.display="flex";
      if(ev){
        document.getElementById("formTitle").innerText="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡∏≤‡∏ô";
        document.getElementById("eventId").value=ev.id;
        document.getElementById("date").value=ev.date;
        document.getElementById("title").value=ev.title;
        document.getElementById("startTime").value=ev.startTime;
        document.getElementById("endTime").value=ev.endTime;
        document.getElementById("location").value=ev.location;
        document.getElementById("owner").value=ev.owner;
        document.getElementById("details").value=ev.details;
      }
    }
    function closeForm(){ document.getElementById("eventForm").style.display="none"; }

    async function saveEvent(e){
      e.preventDefault();
      const ev = {
        id: document.getElementById("eventId").value,
        date: document.getElementById("date").value,
        title: document.getElementById("title").value,
        startTime: document.getElementById("startTime").value,
        endTime: document.getElementById("endTime").value,
        location: document.getElementById("location").value,
        owner: document.getElementById("owner").value,
        details: document.getElementById("details").value
      };
      await fetch(API_URL, {
        method:"POST",
        body:JSON.stringify({mode: ev.id? "edit":"add", payload: ev})
      });
      closeForm();
      loadEvents();
    }

    async function editEvent(id){
      const ev = events.find(x=>x.id==id);
      openForm(ev);
    }

    async function deleteEvent(id){
      if(confirm("‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")){
        await fetch(API_URL,{
          method:"POST",
          body:JSON.stringify({mode:"delete", payload:{id}})
        });
        loadEvents();
      }
    }

    function exportCSV(){
      let csv = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà,‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á,‡πÄ‡∏ß‡∏•‡∏≤,‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà,‡∏ù‡πà‡∏≤‡∏¢‡∏á‡∏≤‡∏ô,‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î\n";
      events.forEach(ev=>{
        csv += ${ev.date},"${ev.title}",${ev.startTime}-${ev.endTime},${ev.location},${ev.owner},"${ev.details}"\n;
      });
      let blob = new Blob([csv], {type:"text/csv"});
      let url = URL.createObjectURL(blob);
      let a = document.createElement("a");
      a.href=url; a.download="calendar.csv"; a.click();
    }

    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏á‡∏≤‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ
    function scheduleNotification(ev){
      if(Notification.permission !== "granted"){
        Notification.requestPermission();
      }
      let start = new Date(ev.date+"T"+ev.startTime);
      let diff = start.getTime() - Date.now() - (30*60*1000);
      if(diff>0){
        setTimeout(()=>{
          new Notification("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á", {body: ev.title+" ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤ "+ev.startTime});
        }, diff);
      }
    }

    loadEvents();
  </script>
</body>
</html>
