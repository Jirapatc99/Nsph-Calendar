<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡∏ô‡∏®‡∏¥‡∏•‡∏≤‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

<style>
  :root{ --grad-a:#93c5fd; --grad-b:#e0f2fe; }
  html,body{height:100%}
  body{font-family:'Prompt',system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Thai',sans-serif}
  .bg-grad{ background:linear-gradient(135deg,var(--grad-a),var(--grad-b)); }
  .card{ background:#fff; border-radius:22px; box-shadow:0 10px 30px rgba(15,23,42,.08),0 2px 8px rgba(15,23,42,.06); }
  .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .9rem; border-radius:14px; background:#fff; box-shadow:0 6px 16px rgba(15,23,42,.06); }
  .btn:hover{ background:#f8fafc }
  .btn-primary{ background:linear-gradient(135deg,#38bdf8,#3b82f6); color:#fff; }
  .btn-primary:hover{ filter:brightness(1.05) }

  /* Header (‡∏™‡∏ß‡∏¢/‡πÇ‡∏õ‡∏£) */
  .hero-card{display:flex;gap:1rem;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .hero-left{display:flex;gap:.9rem;align-items:center;min-width:260px}
  .hero-logo{width:72px;height:72px;border-radius:20px;background:#fff;box-shadow:0 8px 18px rgba(15,23,42,.08);display:grid;place-items:center;overflow:hidden}
  .hero-logo img{width:100%;height:100%;object-fit:contain}
  .hero-badges{display:flex;gap:.5rem;flex-wrap:wrap}
  .badge{background:#fff;border-radius:999px;padding:.35rem .75rem;box-shadow:0 6px 14px rgba(15,23,42,.06)}
  .badge b{font-weight:700}
  /* Calendar */
  .grid-7{ display:grid; grid-template-columns:repeat(7,minmax(0,1fr)); gap:.6rem; }
  .dow{ text-align:center; font-weight:600; color:#334155 }
  .day{ min-height:118px; position:relative; padding:.6rem .55rem .55rem .55rem; border-radius:18px; background:#fff; }
  .day.sun{ box-shadow: inset 0 0 0 2px rgba(239,68,68,.15); background:rgba(239,68,68,.06); }
  .day.sat{ box-shadow: inset 0 0 0 2px rgba(99,102,241,.18); background:rgba(99,102,241,.06); }
  .day .num{ position:absolute; top:.5rem; right:.65rem; font-weight:600; color:#475569 }
  .today-badge{ position:absolute; top:.55rem; left:.6rem; background:linear-gradient(135deg,#0ea5e9,#38bdf8); color:#fff; padding:.1rem .5rem; border-radius:999px; font-size:.72rem; font-weight:700; }
  .chip{ display:flex; gap:.35rem; align-items:center; font-size:.8rem; padding:.22rem .48rem; border-radius:10px; margin:.25rem 0; cursor:pointer;
         background:#eef2ff; color:#4338ca; box-shadow:0 2px 6px rgba(67,56,202,.08); }
  .chip:hover{ filter:brightness(1.02) }
  .chip.allDay{ background:#ecfeff; color:#0369a1; box-shadow:0 2px 6px rgba(3,105,161,.08); }
  .chip.range{ background:#f0fdf4; color:#166534; box-shadow:0 2px 6px rgba(22,101,52,.08); }
  .muted{ opacity:.38 }
  .list-card{ display:grid; grid-template-columns:64px 1fr auto; gap:.9rem; align-items:center; }
  .list-date{ text-align:center; line-height:1.05; }
  .list-date .d{ font-size:1.25rem; font-weight:800; }
  .modal{ position:fixed; inset:0; display:none; place-items:center; z-index:50; background:rgba(15,23,42,.45); backdrop-filter:blur(2px); }
  .modal.show{ display:grid; }
  .modal-card{ width:min(880px,92vw); background:#fff; border-radius:20px; padding:1.25rem; box-shadow:0 24px 48px rgba(15,23,42,.25); }
  .field{ width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.55rem .8rem; }
  @media (max-width:640px){ .day{ min-height:100px } .chip{ font-size:.72rem } }
</style>
</head>
<body class="bg-grad text-slate-800">

<!-- HEADER -->
<header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">
  <div class="card p-5 hero-card">
    <div class="hero-left">
      <div class="hero-logo"><img src="./logo.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"></div>
      <div>
        <h1 class="text-xl sm:text-2xl font-semibold">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÇ‡∏ô‡∏ô‡∏®‡∏¥‡∏•‡∏≤‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</h1>
        <p class="text-slate-500 text-sm">‡πÇ‡∏î‡∏¢ ‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</p>
      </div>
    </div>
    <div class="hero-badges">
      <span class="badge">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: <b id="connStatus">‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</b></span>
      <span class="badge">‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="countAll">0</b></span>
      <span class="badge">‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <b id="countMonth">0</b></span>
      <span class="badge">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <b id="countToday">0</b></span>
    </div>
  </div>
</header>
<!-- CONTROL BAR -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-5">
  <div class="card p-3 flex flex-col lg:flex-row items-center justify-between gap-3">
    <div class="flex flex-wrap gap-2">
      <button id="btnViewMonth" class="btn">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
      <button id="btnViewList" class="btn">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      <button id="btnViewYear" class="btn">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</button>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnPrev" class="btn">‚Äπ</button>
      <div id="currentMonthLabel" class="px-4 py-2 rounded-2xl text-white font-semibold" style="background:linear-gradient(135deg,#38bdf8,#3b82f6);min-width:220px;text-align:center">‚Äì</div>
      <button id="btnNext" class="btn">‚Ä∫</button>
      <button id="btnToday" class="btn">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
    <div class="flex flex-wrap gap-2">
      <button id="btnSync" class="btn">‡∏ã‡∏¥‡∏á‡∏Å‡πå Google Sheets</button>
      <button id="btnAdmin" class="btn btn-primary">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-5 pb-20">

  <!-- DASH -->
  <section class="grid md:grid-cols-4 gap-3">
    <div class="card p-4">
      <div class="text-slate-500 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div class="text-2xl font-bold mt-1" id="dashAll">0</div>
      <div class="h-2 mt-2 rounded-full bg-slate-100"><div id="barAll" class="h-2 rounded-full bg-sky-300 w-0"></div></div>
    </div>
    <div class="card p-4">
      <div class="text-slate-500 text-sm">‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <div class="text-2xl font-bold mt-1" id="dashMonth">0</div>
      <div class="h-2 mt-2 rounded-full bg-slate-100"><div id="barMonth" class="h-2 rounded-full bg-emerald-300 w-0"></div></div>
    </div>
    <div class="card p-4">
      <div class="text-slate-500 text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
      <div class="text-2xl font-bold mt-1" id="dashConn">‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</div>
    </div>
    <div class="card p-4">
      <div class="text-slate-500 text-sm">‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πà‡∏ß‡∏ô</div>
      <div class="mt-2 flex gap-2">
        <select id="quickOwner" class="field"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
        <select id="quickLocation" class="field"><option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option></select>
      </div>
    </div>
  </section>

  <!-- MONTH VIEW -->
  <section id="view-month" class="space-y-3 mt-5">
    <div class="grid-7">
      <div class="dow">‡∏≠‡∏≤</div><div class="dow">‡∏à</div><div class="dow">‡∏≠</div><div class="dow">‡∏û</div><div class="dow">‡∏û‡∏§</div><div class="dow">‡∏®</div><div class="dow">‡∏™</div>
    </div>
    <div id="monthGrid" class="grid-7"></div>

    <div class="card p-4 mt-4">
      <div class="flex items-center justify-between">
        <div class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
        <button id="btnToggleList" class="btn">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á</button>
      </div>
      <div id="monthList" class="mt-3 space-y-2"></div>
    </div>
  </section>

  <!-- LIST VIEW -->
  <section id="view-list" class="hidden space-y-3 mt-5">
    <div class="card p-4 grid md:grid-cols-3 gap-3">
      <input id="searchInput" class="field" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
      <select id="filterMonth" class="field"></select>
      <select id="filterYear" class="field"></select>
    </div>
    <div id="listContainer" class="card p-3 space-y-2"></div>
  </section>

  <!-- YEAR VIEW -->
  <section id="view-year" class="hidden mt-5">
    <div id="yearGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </section>
</main>

<!-- MODALS -->
<!-- Day modal -->
<div id="modal-day" class="modal">
  <div class="modal-card">
    <div class="flex items-center justify-between">
      <h3 id="modalDayTitle" class="text-lg font-semibold">‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‚Ä¶</h3>
      <button class="btn" onclick="closeDayModal()">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div id="modalDayList" class="mt-3 space-y-2"></div>
  </div>
</div>

<!-- Detail modal -->
<div id="modal-detail" class="modal">
  <div class="modal-card">
    <div class="flex items-start justify-between">
      <div class="flex items-center gap-2"><div id="detailEmoji" class="text-2xl">üìå</div><h3 id="detailTitle" class="text-lg font-semibold"></h3></div>
      <button class="btn" onclick="$('#modal-detail').removeClass('show')">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div id="detailBody" class="mt-2 text-sm space-y-1"></div>
  </div>
</div>

<!-- Admin modal (‡∏ï‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î: ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö) -->
<div id="modal-admin" class="modal">
  <div class="modal-card">
    <div class="flex items-center justify-between"><h3 class="text-lg font-semibold">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3><button class="btn" onclick="$('#modal-admin').removeClass('show')">‡∏õ‡∏¥‡∏î</button></div>
    <div class="mt-3 grid md:grid-cols-2 gap-3">
      <input id="f-title" class="field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
      <select id="f-emoji" class="field"></select>

      <div class="md:col-span-2 flex gap-4 items-center">
        <label class="flex items-center gap-2"><input type="radio" name="mode" value="single" checked> ‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</label>
        <label class="flex items-center gap-2"><input type="radio" name="mode" value="range"> ‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô</label>
      </div>

      <div id="wrap-single"><input id="f-date" type="date" class="field"></div>
      <div id="wrap-range" class="hidden grid grid-cols-2 gap-3">
        <input id="f-startDate" type="date" class="field">
        <input id="f-endDate" type="date" class="field">
      </div>

      <input id="f-startTime" type="time" class="field">
      <input id="f-endTime" type="time" class="field">

      <select id="f-location" class="field"></select>
      <select id="f-owner" class="field"></select>

      <textarea id="f-details" rows="3" class="field md:col-span-2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
    </div>

    <div class="mt-4 flex gap-2">
      <button id="btnCreate" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <select id="editSelect" class="field"></select>
      <button id="btnUpdate" class="btn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <button id="btnDelete" class="btn" style="background:#ef4444;color:#fff">‡∏•‡∏ö</button>
    </div>
  </div>
</div>
<!-- Loading -->
<div id="loading" class="modal"><div class="modal-card text-center">
  <div class="mx-auto mb-2 w-10 h-10 rounded-full border-4 border-sky-400 border-t-transparent animate-spin"></div>
  <div class="text-slate-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
</div></div>

<script>
/* ================= CONFIG ================= */
const GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwSkvApjUvQAxn0LijGSEA7GVuPO_LeQGErgmOlugu4_MCrcH2w_k6V2efz7DFxNCf8/exec'; // ‡πÉ‡∏™‡πà URL web app ‡∏ó‡∏µ‡πà deploy ‡πÅ‡∏ö‡∏ö Anyone
const ADMIN_PASSWORD = 'adminvichakarn';
const CACHE_KEY = 'nsph_events_cache_v2';

const EMOJI_CHOICES = ["üéì","üìö","üß™","üî¨","üßÆ","üß†","üóìÔ∏è","‚úèÔ∏è","üìù","üè´","üîî","üèÜ","üéØ","üì¢","üß≠","üñ•Ô∏è"];
const LOCATIONS = ["-‡πÑ‡∏°‡πà‡∏°‡∏µ-.","‡∏´‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏®‡∏¥‡∏•‡∏≤‡∏ô‡∏∏‡∏™‡∏£‡∏ì‡πå","‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏õ‡∏≤‡∏£‡∏¥‡∏ä‡∏≤‡∏ï‡∏¥","‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ü‡πâ‡∏≤","‡πÇ‡∏£‡∏á‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô","‡∏™‡∏ô‡∏≤‡∏°‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•","‡∏™‡∏ô‡∏≤‡∏°‡∏ß‡∏≠‡∏•‡πÄ‡∏•‡∏¢‡πå‡∏ö‡∏≠‡∏•","‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏≤‡∏ò‡∏á","‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏°‡∏µ","‡∏´‡πâ‡∏≠‡∏á‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤","‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°","‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏†‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏´‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£","‡∏´‡πâ‡∏≠‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì","‡∏´‡πâ‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ","‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô","‡∏´‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û","‡∏´‡πâ‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢","‡∏´‡πâ‡∏≠‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©","‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•","‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå","‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå","‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î"];
const OWNERS = ["‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£","‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì","‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ","‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•","‡∏ù‡πà‡∏≤‡∏¢‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"];

/* ================= STATE ================= */
const STATE = { today:new Date(), cursor:new Date(), events:[], admin:false, editing:null };

/* ================= UTIL: Thai/Date ================= */
const thMonths=["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå","‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°","‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô","‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°","‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô","‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°","‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°","‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô","‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°","‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô","‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
function thLabel(d){return `${d.getDate()} ${thMonths[d.getMonth()]} ${d.getFullYear()+543}`;}
function ymLabel(d){return `${thMonths[d.getMonth()]} ${d.getFullYear()+543}`;}
function sameDate(a,b){return a.getFullYear()==b.getFullYear()&&a.getMonth()==b.getMonth()&&a.getDate()==b.getDate();}
function parseAny(v){
  if(!v) return null;
  if(v instanceof Date) return v;
  if(typeof v==='number'){ // excel serial
    const base = new Date(Date.UTC(1899,11,30)); return new Date(base.getTime()+v*86400000);
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)){ const [Y,M,D]=v.split('-').map(Number); return new Date(Y,M-1,D); }
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(v)){ let [D,M,Y]=v.split('/').map(Number); if(Y>2400) Y-=543; return new Date(Y,M-1,D); }
  const d=new Date(v); return isNaN(d)?null:d;
}
function dateInput(v){ const d=parseAny(v); if(!d) return ''; const m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2); return `${d.getFullYear()}-${m}-${dd}`;}
function eventDays(ev){ const d=parseAny(ev.date), s=parseAny(ev.startDate), e=parseAny(ev.endDate);
  if(d) return [d]; if(s&&e){ const arr=[]; let cur=new Date(s); while(cur<=e){arr.push(new Date(cur)); cur.setDate(cur.getDate()+1);} return arr;}
  if(s) return [s]; return [];
}
function timeLabel(ev){ if(ev.startTime&&ev.endTime) return `${ev.startTime}-${ev.endTime}`; if(ev.startTime) return ev.startTime; return '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô'; }
function rangeLabel(ev){ const d=parseAny(ev.date), s=parseAny(ev.startDate), e=parseAny(ev.endDate);
  if(d) return thLabel(d); if(s&&e) return `${thLabel(s)} ‚Äì ${thLabel(e)}`; if(s) return thLabel(s); return ''; }
function escapeHtml(t){ return (t??'').toString().replace(/[&<>"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }

/* ================= DATA ================= */
async function fetchFromGAS(){ try{ const r=await fetch(GAS_ENDPOINT,{cache:'no-store'});const j=await r.json(); if(j.status==='ok') return j.data; }catch(e){} return null; }
async function postToGAS(mode,payload){ const r=await fetch(GAS_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode,payload})}); return r.json(); }
function normalize(rows){ return (rows||[]).map(r=>({id:(r.id??'').toString(),title:r.title??'',date:r.date??'',startDate:r.startDate??'',endDate:r.endDate??'',startTime:r.startTime??'',endTime:r.endTime??'',location:r.location??'',owner:r.owner??'',details:r.details??'',emoji:r.emoji??''})); }
function saveCache(d){ localStorage.setItem(CACHE_KEY, JSON.stringify(d)); }
function loadCache(){ try{ return JSON.parse(localStorage.getItem(CACHE_KEY)||'[]'); }catch{ return []; } }

/* ================= RENDER ================= */
function renderHeader(){ $('#currentMonthLabel').text(ymLabel(STATE.cursor)); $('#dashConn').text($('#connStatus').text()); }
function eventsOnDate(d){ return STATE.events.filter(ev=>eventDays(ev).some(x=>sameDate(x,d))); }
function monthEvents(y,m){ return STATE.events.filter(ev=>{
  const d=parseAny(ev.date), s=parseAny(ev.startDate), e=parseAny(ev.endDate);
  if(d) return d.getFullYear()==y && d.getMonth()==m;
  if(s&&e){ const ms=new Date(y,m,1), me=new Date(y,m+1,0); return e>=ms && s<=me; }
  if(s) return s.getFullYear()==y && s.getMonth()==m;
  return false;
}).sort((a,b)=> (parseAny(a.date)||parseAny(a.startDate))- (parseAny(b.date)||parseAny(b.startDate))); }

function chipHtml(ev){
  const title = (ev.title && ev.title.toString().trim()) ? ev.title : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';
  const kind = ev.date ? 'allDay' : (ev.startDate && ev.endDate ? 'range' : 'allDay');
  
  // ‡πÄ‡∏ß‡∏•‡∏≤ (‡πÉ‡∏ä‡πâ startTime + endTime)
  let time = '';
  if(ev.startTime && ev.endTime){
    time = `${ev.startTime} - ${ev.endTime}`;
  } else if(ev.startTime){
    time = ev.startTime;
  } else {
    time = '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô';
  }

  return `
    <div class="chip ${kind}" onclick="openDetail('${ev.id}')">
      <span>${ev.emoji || 'üìå'} ${escapeHtml(title)}</span>
      <span class="opacity-70">‚Ä¢ ${time}</span>
    </div>
  `;
}

function renderMonthGrid(){
  const y=STATE.cursor.getFullYear(), m=STATE.cursor.getMonth();
  const first=new Date(y,m,1), start=first.getDay(), last=new Date(y,m+1,0).getDate();
  const frag=[];
  for(let i=0;i<start;i++) frag.push(`<div class="day muted"></div>`);
  for(let d=1; d<=last; d++){
    const dt = new Date(y,m,d);
    const evs = eventsOnDate(dt);
    const chips = evs.map(chipHtml).join('');
    const today = sameDate(dt, STATE.today) ? <span class="today-badge">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span> : '';
    const wk = dt.getDay()==0?'sun': (dt.getDay()==6?'sat':'');
    frag.push(`<div class="day ${wk}" data-iso="${dt.toISOString()}" onclick="openDayModal('${dt.toISOString()}')">
      ${today}<div class="num">${d}</div>
      <div class="mt-6">${chips || `<div class="text-xs text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`}</div>
    </div>`);
  }
  while(frag.length%7!==0) frag.push(`<div class="day muted"></div>`);
  $('#monthGrid').html(frag.join(''));

  const arr = monthEvents(y,m);
  $('#monthList').html(arr.map(listItem).join('') || `<div class="text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>`);
}

function listItem(ev){
  const start = parseAny(ev.date)||parseAny(ev.startDate)||new Date();
  const d = ('0'+start.getDate()).slice(-2);
  const m = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'][start.getMonth()];
  const y = (start.getFullYear()+543).toString().slice(-4);
  return `<div class="card p-3 list-card">
    <div class="list-date">
      <div class="d">${d}</div>
      <div class="text-xs text-slate-500">${m} ${y}</div>
    </div>
    <div>
      <div class="flex items-center gap-2 text-sky-700"><span class="text-xl">${ev.emoji||'üìå'}</span><b>${escapeHtml(ev.title)}</b></div>
      <div class="text-xs text-slate-600 mt-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${rangeLabel(ev)} ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤: ${timeLabel(ev)}</div>
      <div class="text-xs text-slate-600">${ev.location?`‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${escapeHtml(ev.location)} ‚Ä¢ `:''}${ev.owner?`‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: ${escapeHtml(ev.owner)}`:''}</div>
    </div>
    <div><button class="btn" onclick="openDetail('${ev.id}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button></div>
  </div>`;
}

function renderListView(){
  $('#filterMonth').html(thMonths.map((t,i)=>`<option value="${i}">${t}</option>`).join(''));
  const years=[...new Set(STATE.events.flatMap(ev=>eventDays(ev).map(d=>d.getFullYear()+543)))].sort((a,b)=>a-b);
  $('#filterYear').html(years.map(y=>`<option>${y}</option>`).join(''));
  applyListFilter();
}
function applyListFilter(){
  const q=($('#searchInput').val()||'').toLowerCase();
  const m=+$('#filterMonth').val(), y=+$('#filterYear').val()-543;
  let data=[...STATE.events];
  if(q) data=data.filter(ev=>[ev.title,ev.details,ev.location,ev.owner].join(' ').toLowerCase().includes(q));
  data=data.filter(ev=>{
    const ds=eventDays(ev); return ds.some(d=>(isNaN(m)?true:d.getMonth()==m) && (isNaN(y)?true:d.getFullYear()==y));
  });
  $('#listContainer').html(data.map(listItem).join('')||`<div class="card p-4 text-slate-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`);
}
function renderYearView(){
  const y=STATE.cursor.getFullYear(), box=[];
  for(let m=0;m<12;m++){
    const h=`<div class="font-semibold mb-2">${thMonths[m]} ${y+543}</div>`;
    const first=new Date(y,m,1), last=new Date(y,m+1,0), start=first.getDay();
    let cells=[]; for(let i=0;i<start;i++) cells.push(`<div class="card p-1 opacity-30"></div>`);
    for(let d=1; d<=last.getDate(); d++){ const dd=new Date(y,m,d); const has=eventsOnDate(dd).length>0; cells.push(`<div class="card p-1 text-center text-xs ${has?'bg-sky-50':''}">${d}</div>`); }
    box.push(`<div class="card p-3">${h}<div class="grid grid-cols-7 gap-1 text-center text-xs text-slate-500 mb-1"><div>‡∏≠‡∏≤</div><div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div>‡∏™</div></div><div class="grid grid-cols-7 gap-1">${cells.join('')}</div></div>`);
  }
  $('#yearGrid').html(box.join(''));
}
function refreshDash(){
  $('#countAll,#dashAll').text(STATE.events.length);
  const y=STATE.cursor.getFullYear(), m=STATE.cursor.getMonth();
  const month = monthEvents(y,m).length; $('#countMonth,#dashMonth').text(month);
  $('#countToday').text(eventsOnDate(STATE.today).length);
  $('#barAll').css('width', Math.min(100, STATE.events.length*5)+'%');
  $('#barMonth').css('width', Math.min(100, month*10)+'%');
}

/* ================= MODALS / ACTIONS ================= */
function openDayModal(iso){
  const d=new Date(iso); const evs=eventsOnDate(d);
  $('#modalDayTitle').text(`‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${thLabel(d)}`);
  $('#modalDayList').html(evs.map(e=>`
    <div class="card p-3 flex items-start justify-between gap-2">
      <div>
        <div class="flex items-center gap-2 text-sky-700"><span class="text-xl">${e.emoji||'üìå'}</span><b>${escapeHtml(e.title)}</b></div>
        <div class="text-xs text-slate-600 mt-1">‡πÄ‡∏ß‡∏•‡∏≤: ${timeLabel(e)} ${e.location?`‚Ä¢ ${escapeHtml(e.location)}`:''}</div>
      </div>
      <button class="btn" onclick="openDetail('${e.id}')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
    </div>`).join('') || `<div class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`);
  $('#modal-day').addClass('show');
}
function closeDayModal(){ $('#modal-day').removeClass('show'); }
function openDetail(id){
  const e=STATE.events.find(x=>x.id===id); if(!e) return;
  $('#detailEmoji').text(e.emoji||'üìå'); $('#detailTitle').text(e.title);
  $('#detailBody').html(`
    <div>üìÖ ${rangeLabel(e)} ${timeLabel(e)!=='‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô'?`‚Ä¢ ${timeLabel(e)}`:''}</div>
    ${e.location?`<div>üìç ${escapeHtml(e.location)}</div>`:''}
    ${e.owner?`<div>üë§ ${escapeHtml(e.owner)}</div>`:''}
    ${e.details?`<div class="text-slate-600 mt-2">${escapeHtml(e.details)}</div>`:''}
  `);
  $('#modal-detail').addClass('show');
}

/* ================= ADMIN (‡∏¢‡πà‡∏≠) ================= */
$('#btnAdmin').on('click', async ()=>{
  if(!STATE.admin){
    const r=await Swal.fire({title:'‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',input:'password',showCancelButton:true,confirmButtonText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'});
    if(!r.isConfirmed) return;
    if(r.value!==ADMIN_PASSWORD) return Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á','error');
    STATE.admin=true; confetti({particleCount:80,spread:60});
  }
  $('#modal-admin').addClass('show');
});
$('input[name="mode"]').on('change',function(){ const m=this.value; $('#wrap-single').toggleClass('hidden',m!=='single'); $('#wrap-range').toggleClass('hidden',m!=='range'); });
function fillAdminStatic(){
  $('#f-emoji').html(`<option value="">(‡πÑ‡∏°‡πà‡∏°‡∏µ)</option>`+EMOJI_CHOICES.map(e=>`<option>${e}</option>`).join(''));
  $('#f-location').html(LOCATIONS.map(s=>`<option>${s}</option>`).join(''));
  $('#f-owner').html(OWNERS.map(s=>`<option>${s}</option>`).join(''));
}
function collectForm(){
  const m=$('input[name="mode"]:checked').val();
  const p={id:STATE.editing||('ev_'+Date.now()),title:$('#f-title').val(),emoji:$('#f-emoji').val(),startTime:$('#f-startTime').val(),endTime:$('#f-endTime').val(),location:$('#f-location').val(),owner:$('#f-owner').val(),details:$('#f-details').val(),date:'',startDate:'',endDate:''};
  if(m==='single') p.date=$('#f-date').val(); else{ p.startDate=$('#f-startDate').val(); p.endDate=$('#f-endDate').val(); }
  return p;
}
function reloadEditSelect(){ $('#editSelect').html(STATE.events.map(e=>`<option value="${e.id}">${escapeHtml(e.title)}</option>`).join('')); }
$('#btnCreate').on('click', async ()=>{
  const payload=collectForm(); await saveToServer('add',payload);
});
$('#btnUpdate').on('click', async ()=>{
  const id=$('#editSelect').val(); if(!id) return;
  STATE.editing=id; const payload=collectForm(); payload.id=id; await saveToServer('edit',payload);
});
$('#btnDelete').on('click', async ()=>{
  const id=$('#editSelect').val(); if(!id) return;
  const ok=await Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',text:'‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?',icon:'warning',showCancelButton:true});
  if(ok.isConfirmed) await saveToServer('delete',{id});
});
async function saveToServer(mode,payload){
  try{
    $('#loading').addClass('show');
    const js=await postToGAS(mode,payload);
    if(js.status==='ok'){ confetti({particleCount:120,spread:70}); await syncNow(); $('#modal-admin').removeClass('show'); }
    else Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',js.message||'‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ','error');
  }finally{ $('#loading').removeClass('show'); }
}

/* ================= SYNC / INIT ================= */
async function syncNow(){
  try{
    $('#loading').addClass('show');
    const data=await fetchFromGAS();
    if(Array.isArray(data)){
      $('#connStatus').text('‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå').removeClass('text-red-500').addClass('text-green-600');
      STATE.events=normalize(data); saveCache(STATE.events);
      Swal.fire({icon:'success',title:'‡∏ã‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß',timer:1200,showConfirmButton:false});
    }else{
      $('#connStatus').text('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'); STATE.events=loadCache();
      Swal.fire('‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå','‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß','info');
    }
  }catch(e){
    $('#connStatus').text('‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå'); STATE.events=loadCache();
  }finally{
    renderAll(); $('#loading').removeClass('show');
  }
}
function renderAll(){
  renderHeader(); renderMonthGrid(); renderListView(); renderYearView(); refreshDash();
  $('#quickOwner').html(`<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`+[...new Set(STATE.events.map(e=>e.owner).filter(Boolean))].map(x=>`<option>${escapeHtml(x)}</option>`).join(''));
  $('#quickLocation').html(`<option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</option>`+[...new Set(STATE.events.map(e=>e.location).filter(Boolean))].map(x=>`<option>${escapeHtml(x)}</option>`).join(''));
  reloadEditSelect();
}

/* ================= BINDINGS ================= */
$('#btnPrev').on('click',()=>{ STATE.cursor.setMonth(STATE.cursor.getMonth()-1); renderAll(); });
$('#btnNext').on('click',()=>{ STATE.cursor.setMonth(STATE.cursor.getMonth()+1); renderAll(); });
$('#btnToday').on('click',()=>{ STATE.cursor=new Date(); renderAll(); });
$('#btnSync').on('click', syncNow);
$('#btnViewMonth').on('click',()=>{$('#view-month').show();$('#view-list,#view-year').hide();});
$('#btnViewList').on('click',()=>{$('#view-list').show();$('#view-month,#view-year').hide();});
$('#btnViewYear').on('click',()=>{$('#view-year').show();$('#view-month,#view-list').hide();});
$('#btnToggleList').on('click',()=>$('#monthList').toggle());
$('#searchInput,#filterMonth,#filterYear,#quickOwner,#quickLocation').on('input change',applyListFilter);

fillAdminStatic();

/* ================= START ================= */
(async function init(){
  STATE.events=loadCache(); renderAll();
  await syncNow();
})();
</script>
</body>
</html>
